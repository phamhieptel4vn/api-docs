"use strict";(self.webpackChunkapi_docs=self.webpackChunkapi_docs||[]).push([[5652],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var i=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},l=Object.keys(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=i.createContext({}),s=function(e){var t=i.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=s(e.components);return i.createElement(p.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,p=e.parentName,c=r(e,["components","mdxType","originalType","parentName"]),u=s(n),m=a,g=u["".concat(p,".").concat(m)]||u[m]||d[m]||l;return n?i.createElement(g,o(o({ref:t},c),{},{components:n})):i.createElement(g,o({ref:t},c))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,o=new Array(l);o[0]=m;var r={};for(var p in t)hasOwnProperty.call(t,p)&&(r[p]=t[p]);r.originalType=e,r[u]="string"==typeof e?e:a,o[1]=r;for(var s=2;s<l;s++)o[s]=n[s];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"},60659:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>d,frontMatter:()=>l,metadata:()=>r,toc:()=>s});var i=n(87462),a=(n(67294),n(3905));const l={title:"Push notification",sidebar_position:2},o="Pitel Voip Push notification",r={unversionedId:"push_notif",id:"push_notif",title:"Push notification",description:"Warning",source:"@site/pitel_app_voip/push_notif.md",sourceDirName:".",slug:"/push_notif",permalink:"/pitel_app_voip/push_notif",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Push notification",sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Pitel Flutter Voip",permalink:"/pitel_app_voip/"},next:{title:"Example",permalink:"/pitel_app_voip/pitel_ui_kit"}},p={},s=[{value:"Pitel Connect Flow",id:"pitel-connect-flow",level:2},{value:"Image callkit",id:"image-callkit",level:2},{value:"IOS",id:"ios",level:4},{value:"IOS",id:"ios-1",level:4},{value:"Android",id:"android",level:4},{value:"<strong>Usage</strong>",id:"usage",level:2},{value:"How to test",id:"how-to-test",level:2}],c={toc:s},u="wrapper";function d(e){let{components:t,...l}=e;return(0,a.kt)(u,(0,i.Z)({},c,l,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"pitel-voip-push-notification"},"Pitel Voip Push notification"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"Warning"),"\nIOS only working on real device, not on simulator (Callkit framework not working on simulator)")),(0,a.kt)("h2",{id:"pitel-connect-flow"},"Pitel Connect Flow"),(0,a.kt)("p",null,'When user make call from Pitel Connect app, Pitel Server pushes a notification for all user login (who receives the call). When user "Accept" call, extension will re-register to receive call.\n',(0,a.kt)("img",{alt:"Pitel Connect Flow",src:n(64445).Z,width:"1726",height:"976"})),(0,a.kt)("h2",{id:"image-callkit"},"Image callkit"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"space-1.jpg",src:n(53268).Z,width:"300",height:"667"}),"\n",(0,a.kt)("img",{alt:"space-1.jpg",src:n(88790).Z,width:"300",height:"667"}),"\n",(0,a.kt)("img",{alt:"space-1.jpg",src:n(55492).Z,width:"300",height:"534"}),"\n",(0,a.kt)("img",{alt:"space-1.jpg",src:n(88667).Z,width:"300",height:"534"}),"\n",(0,a.kt)("img",{alt:"space-1.jpg",src:n(98082).Z,width:"300",height:"534"})),(0,a.kt)("h1",{id:"setup--certificate"},"Setup & Certificate"),(0,a.kt)("h4",{id:"ios"},"IOS"),(0,a.kt)("p",null,"If you are making VoIP application than you definitely want to update your application in the background & terminate state as well as wake your application when any VoIP call is being received."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1. Create Apple Push Notification certificate.")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Access ",(0,a.kt)("a",{parentName:"li",href:"https://developer.apple.com/account/resources/identifiers/list"},"https://developer.apple.com/account/resources/identifiers/list")),(0,a.kt)("li",{parentName:"ul"},"In\xa0",(0,a.kt)("a",{parentName:"li",href:"https://developer.apple.com/account/resources"},"Certificates, Identifiers & Profiles"),", click Certificates in the sidebar."),(0,a.kt)("li",{parentName:"ul"},"On the top left, click the add button (+).The certificate type should be\xa0Apple Push Notification service SSL (Sandbox & Production)\xa0under\xa0Services.")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"push_img_10",src:n(65301).Z,width:"1544",height:"736"})),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2. Choose an\xa0App ID\xa0from the pop-up menu, then click Continue."),"\n",(0,a.kt)("img",{alt:"push_img_9",src:n(6340).Z,width:"2456",height:"750"})),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"3. Upload Certificate Signing Request \u2192 Continue"),"\n",(0,a.kt)("img",{alt:"push_img_8",src:n(64123).Z,width:"2456",height:"750"})),(0,a.kt)("p",null,"Follow the instructions to\xa0",(0,a.kt)("a",{parentName:"p",href:"https://developer.apple.com/help/account/create-certificates/create-a-certificate-signing-request"},"create a certificate signing request"),"."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Install certificate."),"\nDownload the certificate and install it into the Keychain Access app(download .cer and double click to install)."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Export the .p12 file and send it to Tel4vn (or using test)"),(0,a.kt)("img",{alt:"push_img_7",src:n(47144).Z,width:"1754",height:"1062"}))),(0,a.kt)("h1",{id:"setup-pushkit--callkit"},"Setup Pushkit & Callkit"),(0,a.kt)("h4",{id:"ios-1"},"IOS"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Open Xcode Project \u2192 Capabilities"),(0,a.kt)("li",{parentName:"ul"},"In Tab Signing & Capabilities. Enable Push notifications & Background Modes")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"push_img_5",src:n(80842).Z,width:"1806",height:"1028"})),(0,a.kt)("h4",{id:"android"},"Android"),(0,a.kt)("p",null,"Using FCM (Firebase Cloud Message) to handle push notification wake up app when app run on Background or Terminate"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"Warning"),"\nPopup request permission only working with targetSdkVersion >= 33")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Access link ",(0,a.kt)("a",{parentName:"p",href:"https://console.firebase.google.com/u/0/project/_/notification"},"https://console.firebase.google.com/u/0/project/","_","/notification"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Create your packageId for android app\n",(0,a.kt)("img",{alt:"push_img_4",src:n(27632).Z,width:"1994",height:"1132"}))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Download & copy file google_service.json -> replace file google_service.json in path: ",(0,a.kt)("inlineCode",{parentName:"p"},"android/app/google_service.json"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Go to Project Setting \u2192 Cloud Messaging \u2192 Enable Cloud Messaging API (Legacy)\n",(0,a.kt)("img",{alt:"push_img_3",src:n(45804).Z,width:"2866",height:"1582"})))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"Note"),"\nAfter complete all step Setup. Please send information to dev of Tel4vn in ",(0,a.kt)("a",{parentName:"p",href:"https://portal-sdkdev.tel4vn.com/login"},"here"))),(0,a.kt)("h1",{id:"installation-your-project"},"Installation (your project)"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Install Packages")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-xml"},"flutter pub add flutter_callkit_incoming\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Add pubspec.yaml:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-xml"},"dependencies:\n      flutter_callkit_incoming: any\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Config your project")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Android\nIn android/app/src/main/AndroidManifest.xml")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-xml"},'<manifest...>\n     ...\n     \x3c!--\n         Using for load image from internet\n     --\x3e\n     <uses-permission android:name="android.permission.INTERNET"/>\n </manifest>\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"IOS\nIn ios/Runner/Info.plist")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-xml"},"<key>UIBackgroundModes</key>\n<array>\n    <string>processing</string>\n    <string>remote-notification</string>\n    <string>voip</string>\n</array>\n")),(0,a.kt)("p",null,"Replace your file ios/Runner/AppDelegate.swift with ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/tel4vn/pitel-ui-kit/blob/dev/ios/Runner/AppDelegate.swift"},"AppDelegate.swift")),(0,a.kt)("h2",{id:"usage"},(0,a.kt)("strong",{parentName:"h2"},"Usage")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Before handle Incoming call, you should import package in home screen")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'import "package:plugin_pitel/flutter_pitel_voip.dart";\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Get device push token VoIP.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"await PushVoipNotif.getDeviceToken();\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Get fcm token.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"await PushVoipNotif.getFcmToken();\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Register device token after user login success")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"void _registerDeviceToken() async {\n    final fcmToken = await PushVoipNotif.getFCMToken();\n    final deviceToken = await PushVoipNotif.getDeviceToken();\n    final response = await pitelClient.registerDeviceToken(\n      deviceToken: deviceToken,\n      platform: 'ios',\n      bundleId: '${BundleId}',     // BundleId/packageId\n      domain: '${Domain}',\n      extension: '${UUser}',\n      appMode: kReleaseMode ? 'production' : 'dev', // check APNs certificate of Apple run production or dev mode\n      fcmToken: fcmToken,\n    );\n  }\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Remove Device toke when user logout success")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"void _removeDeviceToken() async {\n    final deviceToken = await PushVoipNotif.getDeviceToken();\n    final response = await pitelClient.removeDeviceToken(\n      deviceToken: deviceToken, // Device token\n      domain: '${Domain}',\n      extension: '${UUser}',\n    );\n}\n\nvoid _logout() {\n    _removeDeviceToken();      // Remove device token\n    pitelCall.unregister();    // Disconnect SIP call when user logout\n}\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Listen events from Push notification for wake up app (top level function. Example app.dart)")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"final pitelService = PitelServiceImpl();\nfinal PitelCall pitelCall = PitelClient.getInstance().pitelCall;\n\nVoipNotifService.listenerEvent(\n      callback: (event) {},\n      onCallAccept: () {\n        // Hanlde success when user press Accept button\n        // Re-register to handle incoming call.\n        handleRegisterCall();\n      },\n      onCallDecline: () {\n        pitelCall.hangup(); // Hanlde decline when user press Decline button\n      },\n    );\n")),(0,a.kt)("h2",{id:"how-to-test"},"How to test"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Download & install app from link ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/onmyway133/PushNotifications/releases"},"https://github.com/onmyway133/PushNotifications/releases"))),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"push_img_2",src:n(48711).Z,width:"1820",height:"428"})),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Fill information and click Send to Test Push Notification")),(0,a.kt)("p",null,"Note: Add .voip after your bundleId to send voip push notification"),(0,a.kt)("p",null,"Example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Your app bundleId: com.pitel.uikit.demo\nVoip push Bundle Id: com.pitel.uikit.demo.voip\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"IOS")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"push_img_1",src:n(8441).Z,width:"1602",height:"1404"})),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Android: using above app or test from Postman")),(0,a.kt)("p",null,"cURL"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'curl --location \'https://fcm.googleapis.com/fcm/send\' \\\n--header \'Content-Type: application/json\' \\\n--header \'Authorization: key=${server_key}\' \\\n--data \'{\n    "registration_ids": [${device_token}],\n    "data":{\n        "uuid": "call_id",\n        "nameCaller": "Anh Quang",\n        "avatar": "Anh Quang",\n        "phoneNumber": "0341111111",\n        "appName": "Pitel Connnect"\n    },\n    "content_available": true,\n    "priority": "high"\n}\'\n')))}d.isMDXComponent=!0},55492:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/call_kit_1-0ef2b2f3e6af95b71e7af91aaeb4d01f.png"},88667:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/call_kit_2-4e44862d1535ec1cc9ead98cee7c5922.png"},98082:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/call_kit_3-c4f86f4c89996843befa481a7af6d764.png"},53268:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/call_kit_android_1-3447b43529ddfe8ecd5f5127f48d1d21.png"},88790:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/call_kit_android_2-c351baed29a6694bdc007faf966ea126.png"},64445:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/pitel_connect_flow-ccd3cde51da89b0c171be33947cee965.png"},8441:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/push_img_1-c7237fe82151c0b9621cecb378dd3654.png"},65301:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/push_img_10-c34846cb8b5c5df2eb20d0d132628dcd.png"},48711:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/push_img_2-0c45794c5631faf274fe525cf0994f23.png"},45804:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/push_img_3-22898f5574c275c9d352b9b48b7279f5.png"},27632:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/push_img_4-cdb72555d35d264cbeb35fda6dc0273e.png"},80842:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/push_img_5-8e933da12d2d71b25129a35561efd623.png"},47144:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/push_img_7-3942256b1a5d719cc05ddb79052c329b.png"},64123:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/push_img_8-fbcaf890f239b386bfd9912a155b5704.png"},6340:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/push_img_9-d1bb09033c45f4965e286c80530c757f.png"}}]);